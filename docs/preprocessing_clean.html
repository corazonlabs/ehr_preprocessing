---

title: preprocessing.clean


keywords: fastai
sidebar: home_sidebar

summary: "Functions to split the raw FHIR dataset, clean and save for further processing & vocab creation."
description: "Functions to split the raw FHIR dataset, clean and save for further processing & vocab creation."
nb_path: "01_preprocessing_clean.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_preprocessing_clean.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data">Data<a class="anchor-link" href="#Data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><a href="https://www.cdc.gov/chronicdisease/about/costs/index.htm">Health and Economic Costs of Chronic Diseases - CDC</a></li>
</ul>
<h3 id="Synthea">Synthea<a class="anchor-link" href="#Synthea"> </a></h3><ul>
<li><a href="https://github.com/synthetichealth/synthea/wiki">Synthea - Wiki</a><ul>
<li>contains details about what the project is and how to get started and generate the data.</li>
</ul>
</li>
<li><a href="https://github.com/synthetichealth/synthea/wiki/CSV-File-Data-Dictionary">Synthea Data Dictionary</a></li>
</ul>
<h4 id="Data-Generation">Data Generation<a class="anchor-link" href="#Data-Generation"> </a></h4><ul>
<li>For our purposes, once Synthea is set up, the following scripts generate the data. </li>
<li>Its important to record the run dates, we will use this during preprocessing.</li>
</ul>
<p><code>./run_synthea -s 12345 -p 10000</code></p>
<ul>
<li>run date: 12-19-2019</li>
<li>{alive=10000, dead=1076}</li>
<li>raw - 1.5GB</li>
</ul>
<p><code>./run_synthea -s 54321 -p 20000</code></p>
<ul>
<li>run date: 11-5-2020</li>
<li>{alive=20000, dead=2195}</li>
<li>csv - 2.9GB</li>
</ul>
<p><code>./run_synthea -s 12345 -p 100000</code></p>
<ul>
<li>run date: 4-4-2020</li>
<li>{alive=100000, dead=10872}</li>
<li>csv - 14.6GB</li>
</ul>
<h3 id="Folder-Structure">Folder Structure<a class="anchor-link" href="#Folder-Structure"> </a></h3><ul>
<li>Choose a location to store all Synthea-generated data (<ul>
<li>for example <code>~/mydatastore</code></li>
</ul>
</li>
<li>Copy data generated by Synthea into this specific folder structure <ul>
<li>for 10K data - <code>mydatastore/datasets/synthea/10K/raw_original</code></li>
</ul>
</li>
<li>Then create a symbolic link called <code>datasets</code> in the current working folder pointing to the datasets folder in the datastore <ul>
<li><code>ln -sfn ~/mydatastore/datasets datasets</code></li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Split">Split<a class="anchor-link" href="#Split"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PATH_1K</span><span class="si">}</span><span class="s1">/raw_original&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;patients.csv&#39;,
 &#39;observations.csv&#39;,
 &#39;allergies.csv&#39;,
 &#39;careplans.csv&#39;,
 &#39;medications.csv&#39;,
 &#39;imaging_studies.csv&#39;,
 &#39;procedures.csv&#39;,
 &#39;conditions.csv&#39;,
 &#39;encounters.csv&#39;,
 &#39;immunizations.csv&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_raw_ehrdata" class="doc_header"><code>read_raw_ehrdata</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_raw_ehrdata</code>(<strong><code>path</code></strong>, <strong><code>csv_names</code></strong>=<em><code>['patients', 'observations', 'allergies', 'careplans', 'medications', 'imaging_studies', 'procedures', 'conditions', 'immunizations']</code></em>)</p>
</blockquote>
<p>Read raw EHR data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">read_raw_ehrdata</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PATH_1K</span><span class="si">}</span><span class="s1">/raw_original&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">patients</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">allergies</span><span class="p">,</span> <span class="n">careplans</span><span class="p">,</span> <span class="n">medications</span><span class="p">,</span> <span class="n">imaging_studies</span><span class="p">,</span> <span class="n">procedures</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">immunizations</span> <span class="o">=</span> <span class="n">dfs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_patients" class="doc_header"><code>split_patients</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_patients</code>(<strong><code>patients</code></strong>, <strong><code>valid_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>test_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>random_state</code></strong>=<em><code>1234</code></em>)</p>
</blockquote>
<p>Split the patients dataframe</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">split_patients</span><span class="p">(</span><span class="n">patients</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Splits:: train: 0.7, valid: 0.2, test: 0.1
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">patients</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(1108, 775, 222, 111)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">patients</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_ehr_dataset" class="doc_header"><code>split_ehr_dataset</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_ehr_dataset</code>(<strong><code>path</code></strong>, <strong><code>valid_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>test_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>random_state</code></strong>=<em><code>1234</code></em>)</p>
</blockquote>
<p>Split EHR dataset into train, valid, test and save</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">split_ehr_dataset</span><span class="p">(</span><span class="n">PATH_1K</span><span class="p">)</span> <span class="c1">#will use default values for split percents</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Splits:: train: 0.6, valid: 0.2, test: 0.2
Split patients into:: Train: 664, Valid: 222, Test: 222 -- Total before split: 1108
Saved train data to datasets/synthea/1K/raw_split/train
Saved valid data to datasets/synthea/1K/raw_split/valid
Saved test data to datasets/synthea/1K/raw_split/test
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Clean">Clean<a class="anchor-link" href="#Clean"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_pts" class="doc_header"><code>cleanup_pts</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_pts</code>(<strong><code>pts</code></strong>, <strong><code>is_train</code></strong>, <strong><code>today</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Clean patients df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_obs" class="doc_header"><code>cleanup_obs</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_obs</code>(<strong><code>obs</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean observations df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Drops rows with null in the <code>VALUE</code> column</li>
<li>Creates a new <code>code</code> column with a concatenation of <code>code</code>, <code>value</code>, <code>units</code> and <code>type</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Vocab creation for Observations</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>For <code>numeric</code></strong></p>

<pre><code>for 'numeric'
    get unique 'codes'
    for each unique code
        get unique 'units'
            for each unique unit
                bucketize 'values'
                create vocab entry for each 'bucket' -- code||value_bucket||units</code></pre>
<p><strong>For <code>text</code></strong></p>

<pre><code>for 'text'
    get unique 'codes'
    for each unique code
        get unique 'units' #this will be null
            for each unique unit
                get unique 'values'
                create vocab entry for each -- code||value||units</code></pre>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_algs" class="doc_header"><code>cleanup_algs</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L121" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_algs</code>(<strong><code>allergies</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean allergies df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_crpls" class="doc_header"><code>cleanup_crpls</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L142" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_crpls</code>(<strong><code>careplans</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean careplans df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_meds" class="doc_header"><code>cleanup_meds</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L163" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_meds</code>(<strong><code>medications</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean <code>medications</code> df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_img" class="doc_header"><code>cleanup_img</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L183" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_img</code>(<strong><code>imaging_studies</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean <code>imaging</code> df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_procs" class="doc_header"><code>cleanup_procs</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L195" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_procs</code>(<strong><code>procedures</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean <code>procedures</code> df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_cnds" class="doc_header"><code>cleanup_cnds</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L207" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_cnds</code>(<strong><code>conditions</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>
<p>Clean <code>conditions</code> df</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_immns" class="doc_header"><code>cleanup_immns</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L227" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_immns</code>(<strong><code>immunizations</code></strong>, <strong><code>is_train</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Clean-all">Clean all<a class="anchor-link" href="#Clean-all"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cleanup_dataset" class="doc_header"><code>cleanup_dataset</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L238" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cleanup_dataset</code>(<strong><code>path</code></strong>, <strong><code>is_train</code></strong>, <strong><code>today</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Clean all dfs in a split</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_tables</span><span class="p">,</span> <span class="n">code_tables</span> <span class="o">=</span> <span class="n">cleanup_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">PATH_1K</span><span class="si">}</span><span class="s1">/raw_split/train&#39;</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">patients</span><span class="p">,</span> <span class="n">pt_demographics</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">allergies</span><span class="p">,</span> \
<span class="n">careplans</span><span class="p">,</span> <span class="n">medications</span><span class="p">,</span> <span class="n">imaging_studies</span><span class="p">,</span> <span class="n">procedures</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">immunizations</span> <span class="o">=</span> <span class="n">data_tables</span>

<span class="n">pt_codes</span><span class="p">,</span> <span class="n">obs_codes</span><span class="p">,</span> <span class="n">alg_codes</span><span class="p">,</span> <span class="n">crpl_codes</span><span class="p">,</span> <span class="n">med_codes</span><span class="p">,</span> <span class="n">img_codes</span><span class="p">,</span> <span class="n">proc_codes</span><span class="p">,</span> <span class="n">cnd_codes</span><span class="p">,</span> <span class="n">imm_codes</span> <span class="o">=</span> <span class="n">code_tables</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">conditions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>date    26426
code    26426
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">obs_codes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>orig_code    370128
desc         370128
value        370128
units        370128
type         370128
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extract-Labels-(y)-&amp;-Insert-Age">Extract Labels (y) &amp; Insert Age<a class="anchor-link" href="#Extract-Labels-(y)-&amp;-Insert-Age"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The labels we intend to predict are conditions and must be in the <a href="/lemonade/preprocessing_clean.html#CONDITIONS"><code>CONDITIONS</code></a> dict</p>
<ul>
<li>Adding them to the <code>patients</code> df</li>
<li>And adding the patient's age when the condition was recorded</li>
</ul>
<p>Also ..</p>
<ul>
<li>Inserting patient's age in months and years into each record df</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">CONDITIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="s2">&quot;::&quot;</span><span class="p">,</span><span class="n">CONDITIONS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>diabetes :: 44054006||START
stroke :: 230690007||START
alzheimers :: 26929004||START
coronary_heart :: 53741008||START
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_ys" class="doc_header"><code>extract_ys</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L259" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_ys</code>(<strong><code>patients</code></strong>, <strong><code>conditions</code></strong>, <strong><code>cnd_dict</code></strong>=<em><code>{'diabetes': '44054006||START', 'stroke': '230690007||START', 'alzheimers': '26929004||START', 'coronary_heart': '53741008||START'}</code></em>)</p>
</blockquote>
<p>Extract labels from conditions df and add them to patients df with age</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tmp_pts</span> <span class="o">=</span> <span class="n">extract_ys</span><span class="p">(</span><span class="n">patients</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">CONDITIONS</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tmp_pts</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>birthdate             664
diabetes_y            664
diabetes_age           37
stroke_y              664
stroke_age             42
alzheimers_y          664
alzheimers_age         18
coronary_heart_y      664
coronary_heart_age     34
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="insert_age" class="doc_header"><code>insert_age</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L269" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>insert_age</code>(<strong><code>df</code></strong>, <strong><code>pts_df</code></strong>)</p>
</blockquote>
<p>Insert age in years and months into each of the rec dfs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Do-All-Functions">Do All Functions<a class="anchor-link" href="#Do-All-Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="clean_raw_ehrdata" class="doc_header"><code>clean_raw_ehrdata</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L277" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>clean_raw_ehrdata</code>(<strong><code>path</code></strong>, <strong><code>valid_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>test_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>today</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Split, clean, preprocess &amp; save raw EHR data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_cleaned_ehrdata" class="doc_header"><code>load_cleaned_ehrdata</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L307" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_cleaned_ehrdata</code>(<strong><code>path</code></strong>)</p>
</blockquote>
<p>Load cleaned, age-filtered EHR data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_ehr_vocabcodes" class="doc_header"><code>load_ehr_vocabcodes</code><a href="https://github.com/corazonlabs/lemonade/tree/master/lemonade/preprocessing/clean.py#L320" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_ehr_vocabcodes</code>(<strong><code>path</code></strong>)</p>
</blockquote>
<p>Load codes for vocabs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

